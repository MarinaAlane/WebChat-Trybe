<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <title>WEB CHAT - Project</title>
  </head>
  <body>
    <div id="onlineUsers"> Usuários online:</div>
    

    <form id="form-nickname">
      <input id="nickname-box" data-testid="nickname-box">
      <button data-testid="nickname-button">Chance nickname</button>
    </form>

    <section>
      <ul id="messages">
        <% messages.forEach((message) => { %>
          <li data-testid="message"> <%= `${message.timestamp} - ${message.nickname}: ${message.message} `%> </li>
        <% }) %>
      </ul>
    </section>

    <form id="form">
      <input id="messageInput" autocomplete="off" data-testid="message-box" />
      <button type="submit" data-testid="send-button">Send message</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const messages = document.querySelector('#messages');
      const form = document.querySelector('#form');
      const inputMsg = document.querySelector('#messageInput');
      const inputNickname = document.querySelector('#nickname-box');
      const formNickname = document.querySelector('#form-nickname');
      const onlineUsers = document.querySelector('#onlineUsers');
      const kids = document.querySelectorAll('#online-user');
      let allUsers = [];

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (inputMsg.value) {
        const chatMessage = inputMsg.value;
        const { nickname } = findUserById(socket.id);
        const params = { chatMessage, nickname };
        socket.emit('message', params);
        inputMsg.value = '';
      }
      });
      
    /* ALTERAÇÃO DE NICKNAME */
    formNickname.addEventListener('submit', (e) => {
      e.preventDefault();
      const newNickname = inputNickname.value;
      if (inputNickname.value) {
        const updatedUser = { id: socket.id, nickname: newNickname };
        socket.emit('nickname', updatedUser);
      }
      inputNickname.value = '';
      });

    /* FAZ A LISTA DOS ONLINES */
    function makeOnlineUserList(array = []) {
      onlineUsers.textContent = '';
      array.forEach((user) => {
        const newOnUser = document.createElement('p');
        newOnUser.setAttribute('data-testid', 'online-user');
        newOnUser.setAttribute('socketId', user.id);
        newOnUser.innerText = user.nickname;
        if (user.id === socket.id) {
          onlineUsers.prepend(newOnUser);
          return
        }
        onlineUsers.appendChild(newOnUser);
    });
    }

    /* SOCKETS ON */
    socket.on('conectedUsers', (array) => {
      allUsers = array;
      makeOnlineUserList(array);
    });

    socket.on('message', (msg) => {
      createMessage(msg);
    })

    socket.on('history', (history) => {
      console.log('cheguei no history cluente');
      history.forEach((msg) => createMessage(msg));
    });

    // FUNÇÕES AUXILIARES
    const findUserById = (id) => {
      const user = allUsers.find((u) => u.id === id);
      return user;
    };
    const createMessage = (msg) => {
      const newMessage = document.createElement('li');
      newMessage.textContent = msg;
      newMessage.setAttribute('data-testid', 'message');
      newMessage.setAttribute('userSocketId', socket.id);
      messages.appendChild(newMessage);
      window.scrollTo(0, document.body.scrollHeight);
    }
    
    window.onbeforeunload = () => {
      socket.disconnect();
    };
    </script>
  </body>
</html>