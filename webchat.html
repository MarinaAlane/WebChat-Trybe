<!DOCTYPE html>
<html>
  <head>
    <title>WEB CHAT - Project</title>
    <!-- <link rel="stylesheet" href="./chat.css"> -->
  </head>
  <body>
    <h1 id="user-nickname">Aqui seu nickname</h1>
    <div>
      <ul id="onlineUsers"> Usu√°rios online:</ul>
    </div>

    <form id="form-nickname">
      <input id="nickname-box" data-testid="nickname-box">
      <button data-testid="nickname-button">Chance nickname</button>
    </form>

    <section>
      <ul id="messages"></ul>
    </section>

    <form id="form">
      <input id="messageInput" autocomplete="off" data-testid="message-box" />
      <button id="btnMsg" type="submit" data-testid="send-button">Send message</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const messages = document.querySelector('#messages');
      const form = document.querySelector('#form');
      const inputMsg = document.querySelector('#messageInput');
      const inputNickname = document.querySelector('#nickname-box');
      const formNickname = document.querySelector('#form-nickname');
      const nickname = document.querySelector('#user-nickname');
      const onlineUsers = document.querySelector('#onlineUsers');

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (inputMsg.value) {
        // momento 1: o usuario envia uma mensagem;
        const chatMessage = inputMsg.value;
        const userNickname = nickname.innerText;
        const params = { chatMessage, nickname: userNickname };
        socket.emit('message', params);
        inputMsg.value = '';
      }
      });
      // momento: usuario recebe e ve as mensagens; 
      socket.on('message', (msg) => {
      const newMessage = document.createElement('li');
      newMessage.textContent = msg;
      newMessage.setAttribute('data-testid', 'message');
      messages.appendChild(newMessage);
      window.scrollTo(0, document.body.scrollHeight);
    })
/* --------------------- RELACIONADO AO NICKNAME ------------------------ */
    
    socket.on('conectedUsers', (array) => {
      console.log('cheguei no front com o array')
      console.log(array);
      // recebo o array de usuarios
      array.map((user) => {
        // criar li, dar atributos, dar texto
        const newOnUser = document.createElement('li');
        newOnUser.setAttribute('data-testid', 'online-user');
        newOnUser.setAttribute('socketId', user.id);
        newOnUser.innerText = user.nickname;
        // adicionar a ul
        onlineUsers.appendChild(newOnUser);
      });
    });

    formNickname.addEventListener('submit', (e) => {
      e.preventDefault();
      const newNickname = inputNickname.value;
      if (inputNickname.value) {
        console.log(newNickname);
        nickname.innerText = newNickname;
        /* Enviar uma socket pro servidor para alterar o nome do usuario no db */
      }
      inputNickname.value = '';
      });

    function makeid() {
      var text = "";
      var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      for (var i = 0; i < 16; i++)
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      return text;
      /* fonte: https://www.ti-enxame.com/pt/javascript/gere-stringcaracteres-aleatorios-em-javascript/967048592/ */
    };

    </script>
  </body>
</html>