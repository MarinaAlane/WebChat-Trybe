<!DOCTYPE html>
<html>
  <head>
    <title>Web Chat Tribe</title>
  </head>
  <body>
    <h1> Web Chat da JÃ©</h1>
    <h2 id="eu"> Conectando...</h2>

    <div>
      <form id = 'nome'>
        <input type="text" id='input-nome' data-testid="nickname-box" >
        <button type="submit" id="enviar-nome" data-testid="nickname-button">Salvar</button>
      </form>
      <div>
        <ul id='lista-usuarios' ></ul>
      </div>
      <div>
         <ul id="lista-messagens"></ul>
      </div>
     
      <form id = 'menssagens'>
        <input type="text" id='input-menssagem' data-testid="message-box">
        <button type="submit" id="enviar-messagem" data-testid="send-button">Enviar</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
    
      const socket = io();
      const formMenssagens = document.getElementById('menssagens');
      const inputMessagens = document.getElementById('input-menssagem');
      const ulMenssagens = document.getElementById("lista-messagens");
      const formNome = document.getElementById('nome');
      const inputNome = document.getElementById('input-nome');
      const ulUsuarios =  document.getElementById('lista-usuarios');

      socket.on('logado', (usuario)=>{
        document.getElementById('eu').innerText = usuario

        sessionStorage.setItem('nickname', usuario)
        sessionStorage.setItem('id', usuario)

        const newUser = document.createElement('li');
        newUser.textContent = usuario;
        newUser.setAttribute("data-testid", "online-user")
        ulUsuarios.appendChild(newUser);
      });

      socket.on('clientes-logados',(clientes)=>{
        ulUsuarios.innerHTML = "";
        for(var i=0; i<clientes.length; i+=1){
          if(sessionStorage.getItem('nickname') === clientes[i].nome){
            const cliente = clientes[i];
            const nomeCliente = cliente.nome
          
            const newUser = document.createElement('li');
            newUser.textContent = nomeCliente;
            newUser.setAttribute("data-testid", "online-user")
            ulUsuarios.appendChild(newUser);
          }
        }
        for(var i=0; i<clientes.length; i+=1){
          if(sessionStorage.getItem('nickname') !== clientes[i].nome){
            const cliente = clientes[i];
            const nomeCliente = cliente.nome
          
            const newUser = document.createElement('li');
            newUser.textContent = nomeCliente;
            newUser.setAttribute("data-testid", "online-user")
            ulUsuarios.appendChild(newUser);
          }
        }

      });

      socket.on('messagens-DB', (listaMsg)=>{
          listaMsg.forEach((mensagem) => {
          const mensagemDoBanco = document.createElement('li');
          mensagemDoBanco.setAttribute("data-testid", "message")
          mensagemDoBanco.textContent = `${mensagem.time} ${mensagem.nickname}: ${mensagem.chatMessage}`;
          ulMenssagens.appendChild(mensagemDoBanco);
        });
        
      })
      
      formNome.addEventListener('submit', (event)=>{
        event.preventDefault();
        if(inputNome.value){
         socket.emit('nickname', inputNome.value)
         sessionStorage.setItem('nickname', inputNome.value)
          }
        });

      formMenssagens.addEventListener('submit',(event)=>{
        event.preventDefault();
        if(inputMessagens.value){
          socket.emit('message', { 
            chatMessage:inputMessagens.value,
            nickname:sessionStorage.getItem('nickname')
           }
          )
        }
      });

      socket.on('message',(msg)=>{
        const newMessage = document.createElement('li');
        newMessage.setAttribute("data-testid", "message")
        newMessage.textContent = msg;
        ulMenssagens.appendChild(newMessage);
        window.scrollTo(0, document.body.scrollHeight);
      });
    </script>
  </body>

</html>