<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
  </head>
  <body>
    <p id="meuNick"></p>

    <ul id="nickname"></ul>
    <form 
    id="form-nickname">
      <input 
      data-testid="nickname-box" 
      id="nicknameinput" 
      autocomplete="off" />
      <button 
      id="btnnickname" 
      type="submit" 
      data-testid="nickname-button">Save
    </button>
    </form>

    <ul id="messages"></ul>
    <form 
    id="form-message">
      <input 
      data-testid="message-box" 
      id="messageInput" 
      autocomplete="off" />
      <button 
      id="btnsend" 
      type="submit" 
      data-testid="send-button">Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>

    <script>const socket = window.io();

      const form = document.querySelector('#form-message');
      const inputMessage = document.querySelector('#messageInput');      
      
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const meuNick = document.querySelector('#meuNick').innerText;
        socket.emit('message', { nickname: meuNick, chatMessage: inputMessage.value });
        inputMessage.value = '';
      });
      
      const createMessage = (message) => {
        const messagesUl = document.querySelector('#messages');
        const li = document.createElement('li');
        li.innerText = message;
        li.setAttribute('data-testid', 'message'); 
        messagesUl.appendChild(li);
      };

      const createNick = (nickname) => {
        const nicknameUl = document.querySelector('#nickname');
        const li = document.createElement('li');
        li.innerText = nickname;
        li.setAttribute('data-testid', 'online-user'); 
        nicknameUl.appendChild(li);
      }

        socket.on('sendNickname', (nickname) => {
            createNick(nickname);
        });

        const formNick = document.querySelector('#nicknameinput');
        const btnNick = document.querySelector('#btnnickname');

        btnNick.addEventListener('click', (e) => {
          e.preventDefault();
          const nick = formNick.value
          document.querySelector('#meuNick').innerText = nick;
          socket.emit('sendNickname', nick);
        });

        socket.on('newNickname', (online) => {
          document.querySelector('#meuNick').innerText = online[socket.id];
          const nicknameUli = document.querySelector('#nickname');
          while (nicknameUli.firstChild) {
            nicknameUli.removeChild(nicknameUli.firstChild)
          }
        
          createNick(online[socket.id]);

          for (let newU in online) {
            if (newU != socket.id)
            {
              const li = document.createElement('li');
              li.innerText = online[newU] 
              li.setAttribute('data-testid', 'online-user'); 
              nicknameUli.appendChild(li);
            }
          }
        });
        
        socket.on('allMessages', (messages) => {
          console.log(messages);
          messages.forEach(({ message: chatMessage, nickname, timeStamp }) => {
            createMessage(`${timeStamp} - ${nickname}: ${chatMessage}`)
          })
        })  

      socket.on('message', (message) => createMessage(message));
    </script>
  </body>
</html>