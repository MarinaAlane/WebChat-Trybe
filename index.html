<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebChat Project</title>
</head>

<body>
    <div id="onlineUsers">

    </div>
    <form id="usersForm">
        <input id="nickname" data-testid="nickname-box">
        <button data-testid="nickname-button">Login</button>
    </form>

    <ul id="messagesList"></ul>
    <form id="inputsForm">
        <input id="msgField" data-testid="message-box">
        <button data-testid="send-button">Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io('http://localhost:3000');
        let userNickName = '';

        let usersForm = document.getElementById('usersForm');
        let nickname = document.getElementById('nickname');
        let onlineUsers = document.getElementById('onlineUsers');

        let inputsForm = document.getElementById('inputsForm');
        let msgField = document.getElementById('msgField');
        let messagesList = document.getElementById('messagesList');

        // Req. 04
        socket.on('userOnline', (userNick) => {
            userNickName = userNick;
            console.log(userNickName);
            socket.emit('nick', userNick);
        });

        // Req. 02 e 04
        socket.on('usersOnline', (usersOn) => {
            // console.log(userId);
            // userNickName = userId
            // const newUserOn = document.createElement('p');
            // newUserOn.textContent = userId;
            // newUserOn.setAttribute('data-testid', 'online-user');
            // onlineUsers.appendChild(newUserOn);
            // window.scrollTo(0, document.body.scrollHeight);
            // console.log(usersOn);
            onlineUsers.innerHTML = '';
            const
                orderedUsers = usersOn.sort((a, b) => {
                    if (a.id === socket.id) return -1;
                    if (b.id === socket.id) return 1;
                    return 0;
                });

                orderedUsers.forEach(({ userNickName }) => {
                const newUserOn = document.createElement('p');
                newUserOn.innerHTML = userNickName;
                // console.log(newUserOn.innerHTML);
                newUserOn.setAttribute('data-testid', 'online-user');
                onlineUsers.appendChild(newUserOn);
                window.scrollTo(0, document.body.scrollHeight);
            })
        });

        // Req. 02
        usersForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (nickname.value) {
                userNickName = nickname.value;
                socket.emit('nick', userNickName);
                nickname.value = '';
            }
        })

        // Req 1: Front-end (Client) receives input information and send it to the back-end (Server):
        inputsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // console.log(nickname.value);
            // console.log(msgField.value);
            if (msgField.value) {
                socket.emit('message', { nickname: userNickName, chatMessage: msgField.value });
                msgField.value = '';
                // console.log(msgField.value);
            }
        })

        // Req 1: Front-end (Client) receives the return from the back-end (Server) and displays in a list on the screen:
        socket.on('message', (msg) => {
            // console.log(msg);
            const newMessage = document.createElement('li');
            newMessage.innerText = msg;
            newMessage.setAttribute('data-testid', 'message');
            messagesList.appendChild(newMessage);
            window.scrollTo(0, document.body.scrollHeight);
        })

    </script>
</body>

</html>