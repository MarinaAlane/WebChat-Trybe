<!DOCTYPE html>
<html>
  <head>
    <title>Web Chat Tribe</title>
  </head>
  <body>
    <h1> Web Chat da JÃ©</h1>
    <div>
      <form id = 'nome'>
        <input type="text" id='input-nome' data-testid="nickname-box" >
        <button type="submit" id="enviar-nome" data-testid="nickname-button">Salvar</button>
      </form>
      <div>
        <ul id='lista-usuarios' ></ul>
      </div>
      <div>
         <ul id="lista-messagens"></ul>
      </div>
     
      <form id = 'menssagens'>
        <input type="text" id='input-menssagem' data-testid="message-box">
        <button type="submit" id="enviar-messagem" data-testid="send-button">Enviar</button>
      </form>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
    
      const socket = io();
      const formMenssagens = document.getElementById('menssagens');
      const inputMessagens = document.getElementById('input-menssagem');
      const ulMenssagens = document.getElementById("lista-messagens");
      const formNome = document.getElementById('nome');
      const inputNome = document.getElementById('input-nome');
      const ulUsuarios =  document.getElementById('lista-usuarios');

      formNome.addEventListener('submit', (event)=>{
        event.preventDefault();
        if(inputNome.value){
           const tagsLi = document.getElementsByTagName('li');
           for(var i = 0; i < tagsLi.length; i+=1){
             if(tagsLi[i].innerText === sessionStorage.getItem('nickname')){
                sessionStorage.setItem('nickname', inputNome.value)
                return tagsLi[i].innerText = inputNome.value;
             }
           }
        }
      })

      socket.on('logado', (usuario)=>{
        sessionStorage.setItem('nickname', usuario)
        sessionStorage.setItem('id', usuario)
        const newUser = document.createElement('li');
        newUser.textContent = usuario;
        newUser.setAttribute("data-testid", "online-user")
        ulUsuarios.appendChild(newUser);
      })

      socket.emit('lista-nome', {
        id: sessionStorage.getItem('id'), 
        nickname: sessionStorage.getItem('nickname')
       });

      socket.on("lista-nome", (nomes)=>{
         for(var i=0; i<nomes.length; i+=1){
            if(nomes[i]!== sessionStorage.getItem("nickname")){
              const newUser = document.createElement('li');
              newUser.textContent = nomes[i].nickname;
              newUser.setAttribute("data-testid", "online-user")
              ulUsuarios.appendChild(newUser);
            }
         }
       })

      formMenssagens.addEventListener('submit',(event)=>{
        event.preventDefault();
        if(inputMessagens.value){
          socket.emit('message', { 
            chatMessage:inputMessagens.value,
            nickname:sessionStorage.getItem('nickname')
           }
          )
        }
      })

      socket.on('message',(msg)=>{
        const newMessage = document.createElement('li');
        newMessage.setAttribute("data-testid", "message")
        newMessage.textContent = msg;
        ulMenssagens.appendChild(newMessage);
        window.scrollTo(0, document.body.scrollHeight);
      })
    </script>
  </body>

</html>