<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
</head>
<body>
  <h4>Usu√°rios Online</h4>
  <ul id="ul-online-user"></ul>
  <form>
    <input type="text" name="username" data-testid="nickname-box" placeholder="Digite seu nickname" id="input-nick"/>
    <button type="submit" data-testid="nickname-button" id="add-new-nick">Salvar</button>
  </form>

  <div>
    <ul id="ul-msg">CHAT</ul>

    <form>
      <input data-testid="message-box" id="input-message" type="text" placeholder="Digite uma nova mensagem aqui"/>
      <button data-testid="send-button" id="send-message">Enviar</button>
    </form>
  </div>
   
    <script src="/socket.io/socket.io.js"></script>
 
    <script>
       const socket = window.io();

let nickname = Math.random().toString(16).substr(2, 8) + Math.random().toString(16).substr(2, 8);

socket.emit('userConnected', nickname);

const btnSendMessage = document.getElementById('send-message');
const inputValue = document.getElementById('input-message');
btnSendMessage.addEventListener('click', (event) => {
  event.preventDefault();
  const chatMessage = inputValue.value;
  console.log(chatMessage);
  socket.emit('message', { nickname, chatMessage });
  inputValue.value = '';
});

const btnChangeNick = document.getElementById('add-new-nick');
const inputNick = document.getElementById('input-nick');
btnChangeNick.addEventListener('click', (event) => {
  event.preventDefault();
  const oldnick = nickname;
  nickname = inputNick.value;
  inputNick.value = '';
  socket.emit('nickUpdate', { nickname, oldnick });
});

const onlineUser = document.querySelector('#ul-online-user');
socket.on('updateList', (array) => {
  onlineUser.innerHTML = '';
  array.forEach((user) => {
    const liUser = document.createElement('li');
    liUser.setAttribute('data-testid', 'online-user');
    liUser.innerText = user.nickname;
      if (socket.id === user.id) {
        onlineUser.prepend(liUser);
      } else {
        onlineUser.appendChild(liUser);
      }
  });
});

const insertMessage = (string) => {
  const li = document.createElement('li');
  li.setAttribute('data-testid', 'message');
  li.innerText = string;
  document.getElementById('ul-msg').appendChild(li);
};

socket.on('message', (string) => {
  insertMessage(string);
});

window.onload = async () => {
  const requisition = await fetch('http://localhost:3000/messages');
  const reqJson = await requisition.json();
  reqJson.forEach(({ message, nickname: nick, timestamp }) => {
    const string = `${timestamp} - ${nick} ${message}`;
      insertMessage(string);
    });
};
    </script>               
</body>
</html>
