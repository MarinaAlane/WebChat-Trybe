<!DOCTYPE html>
<html>

<head>
    <title>Socket IO - Trybe</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            box-sizing: border-box;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
  
</head>
<body>
    <div id="div-nickname">
        <input id="nicknameInput" data-testid="nickname-box" />
        <button id="btn-nickname" data-testid="nickname-button" type="button">OK</button>
    </div>
    <ul id="others"></ul>
    <ul id="messages"></ul>

    <form action="" id="form">
        <input id="mensagemInput" data-testid="message-box" autocomplete="off" />
        <button data-testid="send-button" >Send</button>
    </form>

    <script>
       const socket = io();
       const form = document.querySelector('#form');
       const inputMessage = document.querySelector('#mensagemInput')
       const nicknameBtn = document.querySelector('#btn-nickname');
       form.addEventListener('submit', (e) => {
           e.preventDefault();
           const span = document.querySelector('span');
           console.log(span.innerText);
           if(inputMessage.value) {
             const data = {
                 nickname: span.innerText,
                 chatMessage: inputMessage.value,
             }
             console.log(data);
                socket.emit('message', data);
                inputMessage.value = '';
              }  
         });

            socket.on('message', (message) => {
                const ul = document.querySelector('#messages');
                console.log(message);
                const { dataAtual, horaAtual, nickname, chatMessage } = message;
                const li = document.createElement('li');
                li.setAttribute("data-testid", "message");
                li.textContent = message;
                ul.appendChild(li);
            });
            
            nicknameBtn.addEventListener('click', (e) => {
                const inputNickname = document.querySelector('#nicknameInput');
                const div = document.querySelector('#div-nickname');
                const changeSpan = document.getElementById('online-user');
                div.removeChild(changeSpan);
                const span = document.createElement('span');
                span.setAttribute("data-testid", "online-user");
                span.setAttribute("id", "online-user");
                span.textContent = inputNickname.value;
                div.appendChild(span);
                socket.emit('nickname', inputNickname.value);
            });

            window.onload = () => {
                let nickname = document.getElementById('nickname');
                let radomString = [...Array(16)].map(i=>(~~(Math.random()*36)).toString(36)).join('')
                const div = document.querySelector('#div-nickname');
                const span = document.createElement('span');
                span.setAttribute("data-testid", "online-user");
                span.setAttribute("id", "online-user");
                span.textContent = radomString;
                div.appendChild(span);
                socket.emit('adduser', radomString);
            }

            socket.on('users', (users) => {
                const index = users.findIndex(item => item.id === socket.id);
                users.splice(index, 1);
                console.log(users);
                const list = document.getElementById('others');
                list.innerText = ""
                for (let i = 0; i < users.length; i++) {
                    console.log(users[i].nome);
                    const listChild = document.createElement('li');
                    listChild.setAttribute("data-testid", "online-user");
                    listChild.setAttribute("id", `online-user-${users[i].id}`);
                    listChild.textContent = users[i].nome;
                    list.appendChild(listChild);
                }
                });

                socket.on('history', (history) => {
                    const ul = document.querySelector('#messages');
                    console.log(history);
                    if (history.length === 0) {
                        console.log('NÃ£o tem mensagens');
                    } else {
                        for (let i = 0; i < history.length; i++) {
                            const { message, nickname } = history[i];
                            const date = new Date();
                            const dateActual = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                            const timeActual = `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
                            const printDados = `${dateActual} ${timeActual} - ${nickname}: ${message}`;
                            const li = document.createElement('li');
                            li.setAttribute("data-testid", "message");
                            li.textContent = printDados;
                            ul.appendChild(li);    
                        }
                    }
                    });

    </script>

</body>

</html>
