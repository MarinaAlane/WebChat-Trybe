<!DOCTYPE html>

<head>

 <title>Socket IO - Trybe</title>
 <style>
   
      body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

      #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
      #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
      #input:focus { outline: none; }
      #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }

      #ul-msg { list-style-type: none; margin: 0; padding: 0; }
      #ul-msg > li { padding: 0.5rem 1rem; }
      #ul-msg > li:nth-child(odd) { background: #efefef; }
    
</style>
</head>
<body>
  <h4>Usu√°rios Online</h4>
  <ul id="ul-online-user"></ul>
  <form >
    <input type="text" name="username" data-testid="nickname-box" placeholder="Digite seu nickname" id="input-nick"/>
    <button type="submit" data-testid="nickname-button" id="add-new-nick">Salvar</button>
  </form>

  <div>
    <ul id="ul-msg"></ul>

    <form id="form" action="">
      <input data-testid="message-box" id="input-message" type="text" placeholder="Digite uma nova mensagem aqui"/>
      <button data-testid="send-button" id="send-message">Enviar</button>
    </form>
  </div>
   
    <script src="/socket.io/socket.io.js"></script>
 
    <script>
       const socket = window.io();

let nickname = Math.random().toString(16).substr(2, 8) + Math.random().toString(16).substr(2, 8);

socket.emit('user', nickname);

const enviarMensagem = document.getElementById('send-message');
const inputValue = document.getElementById('input-message');
enviarMensagem.addEventListener('click', (event) => {
  event.preventDefault();
  const chatMessage = inputValue.value;
  console.log(chatMessage);
  socket.emit('message', { nickname, chatMessage });
  inputValue.value = '';
});

const mudarUsuario = document.getElementById('add-new-nick');
const inputNick = document.getElementById('input-nick');
mudarUsuario.addEventListener('click', (event) => {
  event.preventDefault();
  const oldnick = nickname;
  nickname = inputNick.value;
  inputNick.value = '';
  socket.emit('changeNick', { nickname, oldnick });
});

const usuarioConectado = document.querySelector('#ul-online-user');
socket.on('onlineList', (array) => {
  usuarioConectado.innerHTML = '';
  array.forEach((user) => {
    const liUser = document.createElement('li');
    liUser.setAttribute('data-testid', 'online-user');
    liUser.innerText = user.nickname;
      if (socket.id === user.id) {
        usuarioConectado.prepend(liUser);
      } else {
        usuarioConectado.appendChild(liUser);
      }
  });
});

const mensagemInserida = (string) => {
  const li = document.createElement('li');
  li.setAttribute('data-testid', 'message');
  li.innerText = string;
  document.getElementById('ul-msg').appendChild(li);
};

socket.on('message', (string) => {
  mensagemInserida(string);
});

window.onload = async () => {
  const req = await fetch('http://localhost:3000/messages');
  const result = await req.json();
  result.forEach(({ message, nickname: nick, timestamp }) => {
    const string = `${timestamp} - ${nick} ${message}`;
    mensagemInserida(string);
    });
};
    </script>               
</body>
</html>
