<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webchat</title>
</head>
  <body>
    <div class="container">
      
      <form class="nickname-form">
        <input type="text" class="nickname-input" placeholder="Nome de usuÃ¡rio" data-testid="nickname-box"v/>
        <button type="submit" class="nickname-button" data-testid="nickname-button">
          Salvar
        </button>
      </form>

      <div class="chat">
        <ul class="users"></ul>
        <ul class="messages"></ul>
      </div>

      <form class="message-form">
        <input type="text" class="message-input" placeholder="Mensagem" data-testid="message-box"/>
        <button type="submit" class="message-button" data-testid="send-button">
          Enviar
        </button>
      </form>
    </div>

    <script src='/socket.io/socket.io.js'></script>
    <script>
      const users = document.querySelector('.users');
      const msgForm = document.querySelector('form.message-form');
      const msgInput = document.querySelector('.message-input');
      const msgButton = document.querySelector('.message-button');
      const messages = document.querySelector('.messages');
      const nickForm = document.querySelector('.nickname-form');
      const nickInput = document.querySelector('.nickname-input');
      
      

      let nickname = '';

      const socket = window.io();

      msgForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (msgInput.value) {
          socket.emit('message', { nickname, chatMessage: msgInput.value });
          msgInput.value = '';
        }
      })

      nickForm.addEventListener('click', (event) => { 
        event.preventDefault(); 
        nickname = nickInput.value;
        nickInput.value = '';
        socket.emit('saveNick', nickname);
      });

      const createMessage = (msg) => {
        const newMsg = document.createElement('li');
        newMsg.textContent = msg;
        newMsg.setAttribute('data-testid', 'message');
        messages.appendChild(newMsg);
      }

      const listUsers = (nick) => {
        const li = document.createElement('li');
        li.textContent = nick.nickname;
        li.setAttribute('data-testid', 'online-user');
        users.appendChild(li);
      }

      socket.on('message', createMessage)

      socket.on('getMessages', (msgList) => {
        msgList.forEach((msg) => {
          createMessage(
            `${msg.timestamp} - ${msg.nickname}: ${msg.message}`
          );
        })
      })

      socket.on('users', (userList) => {
        users.innerHTML = '';
        console.log(userList)
        const user = userList.find((item) => item.id === socket.id);
        listUsers(user); 
        userList.forEach((item) => item.id !== socket.id && listUsers(item));
      });

      socket.on('newUser', (newId) => {
        nickname = newId;
        socket.emit('users');
      })

    </script>
  </body>
</html> 