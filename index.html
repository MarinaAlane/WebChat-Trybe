<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Projeto Webchat</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link  rel="stylesheet"  href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"  integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"  crossorigin="anonymous">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
<body>
  <script src="socket.io/socket.io.js"></script>

  <form id="formClient">
    <div class="col-auto">
      <label for="inputPassword2" data-testid="nickname-box" class="visually-hidden">Mudar apelido</label>
      <input type="text" data-testid="nickname-box" class="form-control" id="inputUser" >
    </div>
    <div class="col-auto">
      <button type="submit" data-testid="nickname-button" class="btn btn-primary mb-3">Confirmar</button>
    </div>
  </form>

      <ul class="list-group" id="messagens">
      </ul>
    
      <form class="row g-3" id="form" action="post">
        <div class="col-auto">
        </div>
        <div class="col-auto">
          <input type="text" id="input" data-testid="message-box" class="form-control" id="messagens" placeholder="Escrever">
        </div>
        <div class="col-auto">
          <button type="submit" id="submit" data-testid="send-button" class="btn btn-primary mb-3">Enviar</button>
        </div>
      </form>
      <ul class="list-group" id="list-user-ul">
      </ul>
    <script>
      // conexão com o socket do servidor
        const socket = io();

          // Função para gerar 16 caracteres aleatórios
       function geraStringAleatoria(tamanho) {
    var stringAleatoria = '';
    var caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    for (var i = 0; i < tamanho; i++) {
        stringAleatoria += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }
    return stringAleatoria;
    // solução : https://www.webtutorial.com.br/funcao-para-gerar-uma-string-aleatoria-random-com-caracteres-especificos-em-javascript/
  }
      
      // elementos id da página
        const form = document.querySelector('#form');
        const input = document.querySelector('#input');
        const messages = document.querySelector('#messagens')

        const formUser = document.querySelector('#formClient')
        const inputUser = document.querySelector('#inputUser');
        const onlineUser = document.querySelector('#list-user-ul');

      // Evento de mensagem (Enviar)
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const msg = {
          nickname: sessionStorage.getItem('nickUser'),
          chatMessage: input.value,
        } 
            socket.emit('message', msg);
        })

        // Evento de trocar nome de usuário
        formUser.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const userActual = sessionStorage.getItem('nickUser');
            sessionStorage.setItem('nickUser', inputUser.value);
            socket.emit('newNickName', { userModify: inputUser.value, userActual  });
        });

        // Evento de receber mensagem e distribuir
        socket.on('message', (msg) => {
            const newMessage = document.createElement('li');
            newMessage.setAttribute('data-testid', 'message');
            newMessage.textContent = msg;
            messages.appendChild(newMessage);
        });

        socket.on('dbMessages', (msg) => {
            if (msg) {
              console.log(msg);
                msg.map(function (mensagem) {
                const messagesLi = document.createElement('li');
                messagesLi.setAttribute('data-testid', 'message');
                messagesLi.textContent = `${mensagem.timestamp} ${mensagem.nickname} ${mensagem.message}`
                messages.appendChild(messagesLi);
              });
              }
        });

        sessionStorage.setItem('nickUser', geraStringAleatoria(16));
          const userOn = sessionStorage.getItem('nickUser')
          socket.emit('onlineUserOn', userOn);

        socket.on('onlineUserOn', (msg) => {
          const { listUsers } = msg;

            const { user } = listUsers;
            while(onlineUser.hasChildNodes()){

            onlineUser.removeChild(onlineUser.firstChild);
          }   

          const userOnLi = sessionStorage.getItem('nickUser')

          const newMessageLi = document.createElement('li');
            newMessageLi.setAttribute('data-testid', 'online-user');
            newMessageLi.setAttribute('id', user);
            newMessageLi.textContent = userOnLi;
            onlineUser.appendChild(newMessageLi);
            
          listUsers.forEach(element => {
            if(element.user != userOnLi) {
            const newMessage = document.createElement('li');
            console.log('Elemento do array', element.user);
            newMessage.setAttribute('data-testid', 'online-user');
            newMessage.setAttribute('id', element.user);
            newMessage.textContent = element.user;
            onlineUser.appendChild(newMessage);
          }
        });
          });

        socket.on('disconectou', () => {
          const myNick = sessionStorage.getItem('nickUser');
          socket.emit('desconectado', myNick);
        })

    </script>
    <script>
     
      socket.on('newNickName', (msg) => {
        const { userActual, userModify } = msg;
        nickAtual = sessionStorage.getItem('nickUser');
        const li = document.getElementById(userActual);
        li.textContent = userModify;
        li.setAttribute('id', nickAtual);

       });
    </script>
</body>
</html>