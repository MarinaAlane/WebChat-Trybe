<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
  </head>
  <body>
    <input id="nickInput"type="text" placeholder="Digite seu nickname" data-testid="nickname-box"/>
    <button type="button" id="nickButton" data-testid="nickname-button">Mudar</button>
    <ul id="messages"></ul>
    <input type="text" id="messageInput" data-testid="message-box"> </input>
    <button type="button" id="sendButton" data-testid="send-button">Enviar</button>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io()
      const sendbutton = document.querySelector('#sendButton');
      const inputMessage = document.querySelector('#messageInput');
      function getNickname(id) {
        const nickName = sessionStorage.getItem('nickname');
        if(!nickName) return id.substr(0, 16);
        return nickName
      }
      sendbutton.addEventListener('click', (e) => {
      e.preventDefault();
      const id = getNickname(socket.id)
      socket.emit('message', {chatMessage: inputMessage.value, nickname:id});
      inputMessage.value = '';
      return false;
      });
      const createMessage = (message) => {
      const messagesUl = document.querySelector('#messages');
      const li = document.createElement('li');
      li.dataset.testid="message";
      li.innerText = message;
      messagesUl.appendChild(li);
      };

      socket.on('newUser', (message) => {
      const messagesUl = document.querySelector('#messages');
      const li = document.createElement('li');
      li.dataset.testid="online-user";
      const id = getNickname(socket.id)
      li.innerText = id;
      messagesUl.appendChild(li);
      })
      socket.on('message', (message) => createMessage(message));
      const nickButton = document.querySelector('#nickButton')
      const nickInput = document.querySelector('#nickInput')
      nickButton.addEventListener('click', (e) => {
        e.preventDefault();
        sessionStorage.setItem('nickname', nickInput.value)
        nickInput.value = ''
      })
      </script>
  </body>
</html>