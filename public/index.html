<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="style.css">
  <title>WebChat</title>
</head>
<body>
  <div class="estrutura">

    <header class="header">
      <h1>Webchat</h1>
    </header>

    <div class="nickNameInput">
      <input
        type="text"
        id="nickNameInput"
        data-testid="nickname-box"
      >
      <button
        type="submit"
        id="nickNameBtn"
        data-testid="nickname-button"
      >
        salvar
      </button>
    </div>

    <div class="nickName">
      <ul id="users"></ul>
    </div>

    <div class="messages">
      <div>
        <ul id="messageUl"></ul>
      </div>
      <input
       type="text"
       id="inputMessage"
       data-testid="message-box"
      >
      <button
        type="submit"
        id="sendBtn"
        data-testid="send-button"
      >
        enviar
      </button>
    </div>

  </div>
  <script>
    const socket = io('localhost:3000');

    const createLi = (user) => {
      const li = document.createElement('li');
      const userId = document.createTextNode(user);
      li.setAttribute('data-testid', 'online-user');
      li.appendChild(userId);
      document.getElementById('users').appendChild(li);
    }

    const sendBtn = document.getElementById('sendBtn');
    const inputMessage = document.getElementById('inputMessage')

    let nameNick = '';

    sendBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if(inputMessage.value) {
        const nickname = nameNick || socket.id;
        socket.emit('message', {chatMessage: inputMessage.value, nickname});
        inputMessage.value = '';
      }
    });

    const nickNameBtn = document.getElementById('nickNameBtn');

    nickNameBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if(nickNameInput.value) {
        nameNick = nickNameInput.value
        socket.emit('nickName', nickNameInput.value);
        nickNameInput.value = '';
      }
    });

    socket.on('message', (text) => {
      const li = document.createElement('li');
      const messageText = document.createTextNode(text);
      li.setAttribute('data-testid', 'message');
      li.appendChild(messageText)
      const messageUl = document.getElementById('messageUl').appendChild(li);
    });

    socket.on('chatHistory', (text) => {
      text.forEach((message) => {
        const li = document.createElement('li');
        const messageText = document.createTextNode(`${message.timestamp} - ${message.nickname} - ${message.chatMessage}`);
        li.setAttribute('data-testid', 'message');
        li.appendChild(messageText)
        const messageUl = document.getElementById('messageUl').appendChild(li);
      });
    });

    socket.on('userList', (user) => {
      const userUl = document.querySelector('#users');
      const usersLi = userUl.childElementCount;
      // tirando todas li's para colocar de novo
      if (usersLi > 0) {
        while (userUl.firstChild) {
          userUl.removeChild(userUl.lastChild);
        }
      }
      if (!nameNick) nameNick = user.slice(-1)[0];
      createLi(nameNick);
      const newUsers = user.filter((u) => u !== nameNick);
      newUsers.forEach(user => {
        createLi(user)
      });
    });
  </script>
</body>
</html>